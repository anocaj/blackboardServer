package hello;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.*;

@Controller    // This means that this class is a Controller
@RequestMapping(path="/blackboard/") // This means URL's start with /blackboard (after Application path)
public class MainController {
	@Autowired // This means to get the bean called blackboardRepository
	           // Which is auto-generated by Spring, we will use it to handle the data

	private BlackboardRepository blackboardRepository;


	/*@PostMapping(path="/add") // Map ONLY GET Requests
	public @ResponseBody String addNewBlackboard (@RequestParam String name
			, @RequestParam String message) {
		// @ResponseBody means the returned String is the response, not a view name
		// @RequestParam means it is a parameter from the GET or POST request
		
		Blackboard n = new Blackboard();
		n.setName(name);
		n.setMessage(message);
		blackboardRepository.save(n);
		return "Saved";
	}*/

	@GetMapping(path = "/show_blackboards")
	public ResponseEntity  getAllBlackboards() {
        if (blackboardRepository.count() == 0) {
            return new ResponseEntity("No Blackboards exist", HttpStatus.CONFLICT);
        }else {
            return new ResponseEntity(blackboardRepository.findAll(), HttpStatus.OK);
        }
	}

	@GetMapping(path="/exists_blackboard/{name}")
	public ResponseEntity existsBlackboard (@PathVariable String name){
		// This returns a JSON or XML with the Blackboards

		boolean blackboard_exists = blackboardRepository.existsByName(name);

		if (blackboard_exists){
			return new ResponseEntity("Blackboard '" + name + "' exists.", HttpStatus.OK);
		} else if (!blackboard_exists){
			return new ResponseEntity("Blackboard '" + name + "' does not exist.", HttpStatus.OK);
		}
		return new ResponseEntity("Error Occured in /exists_blackboard/{name} request.", HttpStatus.CONFLICT);
	}

	//@GetMapping(path="/create_blackboard") // Map ONLY GET Requests
	@PostMapping(path="/create_blackboard") //
	public ResponseEntity createBlackboard (@RequestBody String name) {
		// @ResponseBody means the returned String is the response, not a view name
		// @RequestParam means it is a parameter from the GET or POST request

		/*Log l = new Log();
		l.setAddress("test");
		l.setRequest("Post");
		logRepository.save(l);*/

		boolean existsBlackboard = blackboardRepository.existsByName(name);

		if (blackboardRepository.count() > 10) {
			return new ResponseEntity("Blackboard exceeds maximum number of allowed blackboards", HttpStatus.CONFLICT);
		} else {
			if (existsBlackboard){
				return new ResponseEntity("Blackboard " + name + " already exists", HttpStatus.CONFLICT);
			} else {

				Blackboard n = new Blackboard();
				n.setName(name);
				blackboardRepository.save(n);
				return new ResponseEntity("Saved Blackboard", HttpStatus.CREATED);
			}
		}
	}

	@PutMapping(path="/display_blackboard/{name}") // Map ONLY GET Requests
	public ResponseEntity displayBlackboard (@PathVariable String name
			, @RequestBody String message) {
		// @ResponseBody means the returned String is the response, not a view name
		// @RequestParam means it is a parameter from the GET or POST request
		boolean existsBlackboard = blackboardRepository.existsByName(name);
		String s = "";
		if (existsBlackboard){
			Blackboard n = new Blackboard();
			n.setName(name);
			n.setMessage(message);
			blackboardRepository.save(n);
			return new ResponseEntity("Blackboard is successfully displayed.",HttpStatus.CREATED);
		} else {

			return new ResponseEntity("Blackboard " + name + " does not exists",HttpStatus.CONFLICT);
		}

	}

	@GetMapping(path="/read_blackboard/{name}")
	public @ResponseBody String getMessage (@PathVariable String name) {
        //

        boolean existsBlackboard = blackboardRepository.existsByName(name);
        if (existsBlackboard) {
            if (isEmptyBlackboard(name).equals("true")) {
                return "Blackboard " + name + " is empty";
            } else {
                Blackboard b = blackboardRepository.findOneByName(name);
                return b.getMessage();
            }

        } else {
            return "Blackboard " + name + " does not exists";
        }


    }

	@GetMapping(path="/clear_blackboard/{name}")
	public @ResponseBody String clearedBlackboard (@PathVariable String name){
		// This returns a JSON or XML with the Blackboards
		boolean existsBlackboard = blackboardRepository.existsByName(name);
		if (existsBlackboard){
			Blackboard n = blackboardRepository.findOneByName(name);
			n.setMessage(null);
			blackboardRepository.save(n);
			return "cleared blackboard";
		} else {

			return "Blackboard " + name + " does not exists.";
		}


	}



	@DeleteMapping(path="/delete_blackboard/{name}")
	public @ResponseBody String deletedBlackboard (@PathVariable String name){
		// This returns a JSON or XML with the Blackboards

		blackboardRepository.deleteBlackboardByName(name);
		return "Deleted blackboard '" + name +"'.";
	}

	@GetMapping(path="/blackboard_status/{name}")
	public ResponseEntity isEmptyBlackboard (@PathVariable String name){
		// This returns a JSON or XML with the Blackboards
		boolean existsBlackboard = blackboardRepository.existsByName(name);
		String s;
		if (existsBlackboard){
			Blackboard b = blackboardRepository.findOneByName(name);
			if (b.getMessage() == null){
				s = "Blackboard '"+ name+ "' has no message.";
			} else {
				s = "Blackboard '"+name+ "' contains a message.";
			}
		} else {
			return new ResponseEntity("Blackboard '"+ name+ "' does not exist.", HttpStatus.CONFLICT);
		}
		return new ResponseEntity(s, HttpStatus.OK);
	}
}
